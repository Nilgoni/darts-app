<script>
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Nicht eingeloggt!');
    window.location.href = 'index.html';
  }

  const urlParams = new URLSearchParams(window.location.search);
  const spieltagId = urlParams.get('id');

  if (!spieltagId) {
    alert('Keine Spieltag-ID gefunden!');
    window.location.href = 'dashboard.html';
  }

  async function loadSpieltag() {
    try {
      const res = await fetch(`/api/spieltag/${spieltagId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(`Status ${res.status}: ${errorText}`);
      }

      const data = await res.json();

      document.getElementById('info').innerHTML = `
        <p><strong>Modus:</strong> ${data.spieltag.modus === 'best_of' ? 'Best of' : 'First to'} ${data.spieltag.runden}</p>
        <p><strong>Rundentyp:</strong> ${data.spieltag.rundenTyp === 'hin' ? 'Nur Hinrunde' : 'Hin- und RÃ¼ckrunde'}</p>
        <p><strong>Teilnehmer:</strong> ${data.spieltag.teilnehmer.map(u => u.username).join(', ')}</p>
      `;

      const matchesDiv = document.getElementById('matches');
      matchesDiv.innerHTML = '';

      data.matches.forEach((match, index) => {
        const div = document.createElement('div');
        div.className = 'card mb-3 shadow-sm';
        div.innerHTML = `
          <div class="card-body">
            <h5>Match ${index + 1}</h5>
            <p class="lead">
              ${match.spieler1.username} vs ${match.spieler2.username}
              ${match.starter ? `<br><small>Startet: ${match.starter.username}</small>` : ''}
            </p>
            ${match.abgeschlossen ? `
              <p class="text-success fw-bold">Ergebnis: ${match.legsSpieler1}:${match.legsSpieler2}</p>
            ` : `
              <div class="row align-items-center">
                <div class="col">
                  <input type="number" min="0" max="10" class="form-control" placeholder="${match.spieler1.username}" value="${match.legsSpieler1}" id="legs1_${match._id}">
                </div>
                <div class="col-auto">:</div>
                <div class="col">
                  <input type="number" min="0" max="10" class="form-control" placeholder="${match.spieler2.username}" value="${match.legsSpieler2}" id="legs2_${match._id}">
                </div>
                <div class="col-auto">
                  <button class="btn btn-primary" onclick="saveMatch('${match._id}')">Speichern</button>
                </div>
              </div>
            `}
          </div>
        `;
        matchesDiv.appendChild(div);
      });

      loadTabelle();
    } catch (err) {
      console.error('Fehler beim Laden des Spieltages:', err);
      document.getElementById('info').innerHTML = '<p class="text-danger">Fehler beim Laden des Spieltages (siehe Console)</p>';
    }
  }

  async function saveMatch(matchId) {
    const legs1 = parseInt(document.getElementById(`legs1_${matchId}`).value) || 0;
    const legs2 = parseInt(document.getElementById(`legs2_${matchId}`).value) || 0;

    try {
      const res = await fetch('/api/match/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ matchId, legs1, legs2 })
      });

      const result = await res.json();
      if (res.ok) {
        alert(result.message || 'Gespeichert!');
        loadSpieltag();
      } else {
        alert(result.error || 'Fehler beim Speichern');
      }
    } catch (err) {
      console.error('Fehler beim Speichern:', err);
      alert('Verbindungsfehler');
    }
  }

  async function loadTabelle() {
    try {
      const res = await fetch(`/api/tabelle/${spieltagId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) throw new Error('Tabelle Fehler');

      const data = await res.json();

      const makeTableHTML = (tableData, id) => {
        if (tableData.length === 0) return '<p>Noch keine Ergebnisse</p>';
        let html = '<thead><tr><th>Platz</th><th>Spieler</th><th>Spiele</th><th>Punkte</th><th>Legs</th><th>Diff</th></tr></thead><tbody>';
        tableData.forEach((row, i) => {
          html += `<tr><td>${i+1}</td><td>${row.username}</td><td>${row.spiele}</td><td>${row.punkte}</td><td>${row.legsFor}:${row.legsAgainst}</td><td>${row.diff > 0 ? '+' : ''}${row.diff}</td></tr>`;
        });
        html += '</tbody>';
        return html;
      };

      document.getElementById('currentTable').innerHTML = makeTableHTML(data.current);
      document.getElementById('overallTable').innerHTML = makeTableHTML(data.overall);
    } catch (err) {
      console.error('Fehler beim Laden der Tabelle:', err);
      document.getElementById('currentTable').innerHTML = '<p class="text-danger">Fehler beim Laden</p>';
      document.getElementById('overallTable').innerHTML = '<p class="text-danger">Fehler beim Laden</p>';
    }
  }

  loadSpieltag();
</script>

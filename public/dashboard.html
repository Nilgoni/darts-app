<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darts App Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="mb-4">Darts App Dashboard</h1>
        <p>Willkommen! Hier kannst du neue Spieltage anlegen.</p>

        <a href="/spieltag-create" class="btn btn-primary mb-3">Neuen Spieltag anlegen</a>
        <a href="/logout" class="btn btn-secondary mb-3">Ausloggen</a>
        <a href="/strafen-manage" class="btn btn-info mb-3">Strafen managen</a>

        <button id="resetAll" class="btn btn-danger mb-3">Alles zurücksetzen</button>

        <h4 class="mt-5">Aktuelle Spieltage (bearbeitbar)</h4>
        <ul id="aktuelleSpieltage" class="list-group mb-4"></ul>

        <h4>Abgeschlossene Spieltage (nur Ansicht)</h4>
        <ul id="abgeschlosseneSpieltage" class="list-group mb-4"></ul>

        <h5 id="gesamtStrafen">Gesamte Strafen: 0.00 €</h5>
        <div id="strafenPerSpieler"></div>

        <h4 class="mt-5">Ewige Tabelle</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Platz</th>
                    <th>Spieler</th>
                    <th>Spiele</th>
                    <th>Punkte</th>
                    <th>Legs</th>
                    <th>Diff</th>
                </tr>
            </thead>
            <tbody id="ewigeTabelle"></tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchSpieltage();
            fetchStrafen();
            fetchEwigeTabelle();

            document.getElementById('resetAll').addEventListener('click', () => {
                if (confirm('Wirklich alles zurücksetzen?')) {
                    fetch('/api/reset-all', { method: 'POST' })
                        .then(() => location.reload());
                }
            });
        });

        function fetchSpieltage() {
            fetch('/api/spieltage')
                .then(res => res.json())
                .then(spieltage => {
                    const aktuelle = document.getElementById('aktuelleSpieltage');
                    const abgeschlossene = document.getElementById('abgeschlosseneSpieltage');
                    aktuelle.innerHTML = '';
                    abgeschlossene.innerHTML = '';

                    spieltage.forEach(spieltag => {
                        const datum = new Date(spieltag.datum).toLocaleDateString('de-DE');
                        const teilnehmerNamen = spieltag.teilnehmer.map(t => t.username).join(' - ');
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `${datum} - ${teilnehmerNamen}`;

                        if (!spieltag.abgeschlossen) {
                            const editBtn = document.createElement('a');
                            editBtn.href = `/spieltag-view/${spieltag._id}`;
                            editBtn.className = 'btn btn-sm btn-primary';
                            editBtn.innerText = 'Bearbeiten';
                            listItem.appendChild(editBtn);
                        }

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-danger';
                        deleteBtn.innerText = 'Löschen';
                        deleteBtn.onclick = () => deleteSpieltag(spieltag._id);
                        listItem.appendChild(deleteBtn);

                        if (spieltag.abgeschlossen) {
                            abgeschlossene.appendChild(listItem);
                        } else {
                            aktuelle.appendChild(listItem);
                        }
                    });
                });
        }

        function deleteSpieltag(id) {
            if (confirm('Spieltag löschen?')) {
                fetch(`/api/spieltag/${id}`, { method: 'DELETE' })
                    .then(() => fetchSpieltage());
            }
        }

        function fetchStrafen() {
            fetch('/api/strafen')
                .then(res => res.json())
                .then(strafen => {
                    const strafenPerSpieler = new Map();
                    let gesamtStrafen = 0;

                    strafen.forEach(strafe => {
                        const betrag = strafe.type.betrag;
                        const whoPays = strafe.type.whoPays;
                        const werferUsername = strafe.werfer.username;
                        const teilnehmer = strafe.spieltag.teilnehmer; // Array von User-Objekten

                        if (whoPays === 'werfer') {
                            let current = strafenPerSpieler.get(werferUsername) || 0;
                            strafenPerSpieler.set(werferUsername, current + betrag);
                            gesamtStrafen += betrag;
                        } else if (whoPays === 'alle_anderen') {
                            teilnehmer.forEach(spieler => {
                                if (spieler.username !== werferUsername) {
                                    let current = strafenPerSpieler.get(spieler.username) || 0;
                                    strafenPerSpieler.set(spieler.username, current + betrag);
                                    gesamtStrafen += betrag;
                                }
                            });
                        }
                    });

                    document.getElementById('gesamtStrafen').innerText = `Gesamte Strafen: ${gesamtStrafen.toFixed(2)} €`;

                    // Pro Spieler anzeigen
                    const container = document.getElementById('strafenPerSpieler');
                    let html = '<h5>Strafen pro Spieler:</h5><ul class="list-group">';
                    for (let [name, sum] of strafenPerSpieler) {
                        if (sum > 0) {
                            html += `<li class="list-group-item">${name}: ${sum.toFixed(2)} €</li>`;
                        }
                    }
                    html += '</ul>';
                    container.innerHTML = html;
                });
        }

        function fetchEwigeTabelle() {
            fetch('/api/spieltage')
                .then(res => res.json())
                .then(spieltage => {
                    const stats = new Map();

                    spieltage.forEach(spieltag => {
                        if (spieltag.abgeschlossen) {
                            spieltag.ergebnisse.forEach(ergebnis => {
                                const spieler = ergebnis.spieler.username;
                                if (!stats.has(spieler)) {
                                    stats.set(spieler, { spiele: 0, punkte: 0, legsGew: 0, legsVer: 0 });
                                }
                                const stat = stats.get(spieler);
                                stat.spiele++;
                                stat.punkte += ergebnis.punkte;
                                stat.legsGew += ergebnis.legs.gewonnene;
                                stat.legsVer += ergebnis.legs.verlorene;
                            });
                        }
                    });

                    const sortedStats = Array.from(stats.entries()).sort((a, b) => b[1].punkte - a[1].punkte);
                    const tabelle = document.getElementById('ewigeTabelle');
                    tabelle.innerHTML = '';

                    sortedStats.forEach((entry, index) => {
                        const [spieler, stat] = entry;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${spieler}</td>
                            <td>${stat.spiele}</td>
                            <td>${stat.punkte}</td>
                            <td>${stat.legsGew}:${stat.legsVer}</td>
                            <td>${stat.legsGew - stat.legsVer}</td>
                        `;
                        tabelle.appendChild(row);
                    });
                });
        }
    </script>
</body>
</html>

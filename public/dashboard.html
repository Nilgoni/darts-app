<script>
  const token = localStorage.getItem('token');

  if (!token) {
    alert('Du bist nicht eingeloggt!');
    window.location.href = 'index.html';
  }

  // Token pr端fen
  fetch('/api/protected', {
    headers: { 'Authorization': `Bearer ${token}` }
  })
  .then(res => {
    if (!res.ok) throw new Error();
  })
  .catch(() => {
    alert('Sitzung abgelaufen. Bitte neu einloggen.');
    localStorage.removeItem('token');
    window.location.href = 'index.html';
  });

  // Ausloggen
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    alert('Erfolgreich ausgeloggt');
    window.location.href = 'index.html';
  });

  // Neu: Spieltage laden und anzeigen
  async function loadSpieltage() {
    try {
      const res = await fetch('/api/spieltage', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) throw new Error('Fehler beim Laden');
      const spieltage = await res.json();

      // Getrennte Listen: Aktuell (nicht abgeschlossen) und Abgeschlossen
      const active = spieltage.filter(s => !s.abgeschlossen);
      const closed = spieltage.filter(s => s.abgeschlossen);

      // HTML f端r aktuelle Spieltage
      let activeHTML = '<h3 class="mt-5">Aktuelle Spieltage (bearbeitbar)</h3><ul class="list-group">';
      if (active.length === 0) {
        activeHTML += '<li class="list-group-item">Keine aktiven Spieltage</li>';
      } else {
        active.forEach(s => {
          activeHTML += `
            <li class="list-group-item">
              <a href="spieltag-view.html?id=${s._id}">${new Date(s.datum).toLocaleDateString('de-DE')} - Ersteller: ${s.ersteller.username} - Teilnehmer: ${s.teilnehmer.map(t => t.username).join(', ')}</a>
            </li>
          `;
        });
      }
      activeHTML += '</ul>';

      // HTML f端r abgeschlossene Spieltage
      let closedHTML = '<h3 class="mt-4">Abgeschlossene Spieltage (nur Ansicht)</h3><ul class="list-group">';
      if (closed.length === 0) {
        closedHTML += '<li class="list-group-item">Keine abgeschlossenen Spieltage</li>';
      } else {
        closed.forEach(s => {
          closedHTML += `
            <li class="list-group-item">
              <a href="spieltag-view.html?id=${s._id}">${new Date(s.datum).toLocaleDateString('de-DE')} - Ersteller: ${s.ersteller.username} - Teilnehmer: ${s.teilnehmer.map(t => t.username).join(', ')}</a>
            </li>
          `;
        });
      }
      closedHTML += '</ul>';

      // F端ge zum DOM hinzu (nach den Buttons)
      const container = document.querySelector('.row.g-4');
      container.insertAdjacentHTML('afterend', activeHTML + closedHTML);
    } catch (err) {
      console.error('Fehler beim Laden der Spieltage:', err);
      // Optional: Zeige eine Fehlermeldung im UI
    }
  }

  // Lade Spieltage beim Start
  loadSpieltage();
</script>
